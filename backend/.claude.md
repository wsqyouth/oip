# OIP Backend - Claude ä¸Šä¸‹æ–‡

> AI åä½œæŒ‡å— - æ¯æ¬¡æ–°ä¼šè¯å¿…è¯»

## ğŸ¯ å¿«é€Ÿç†è§£ï¼ˆ30ç§’ç‰ˆï¼‰

- **é¡¹ç›®**: è·¨å¢ƒè®¢å•æ™ºèƒ½è¯Šæ–­å¹³å°åç«¯
- **æ¶æ„**: dpmain (åŒæ­¥ API æœåŠ¡) + dpsync (å¼‚æ­¥ Worker æœåŠ¡) + common (å…±äº«å†…æ ¸)
- **æ ¸å¿ƒåŠŸèƒ½**: è®¢å•æ¥å…¥ â†’ æ™ºèƒ½è¯Šæ–­ï¼ˆç‰©æµè´¹ç‡ + å¼‚å¸¸æ£€æµ‹ï¼‰â†’ ç»“æœè¿”å›
- **æŠ€æœ¯æ ˆ**: Go + Gin + GORM + MySQL + Redis + Lmstfy
- **ç«¯å£**: dpmain:7777, dpsync:7778

## ğŸ“– å¿…è¯»æ–‡æ¡£ï¼ˆæŒ‰é¡ºåºï¼‰

1. **`PRD.md`** - äº§å“éœ€æ±‚æ–‡æ¡£ï¼ˆç†è§£åšä»€ä¹ˆï¼‰
2. **`ARCHITECTURE.md`** - æ¶æ„è®¾è®¡ï¼ˆç†è§£æ€ä¹ˆåšï¼‰
3. **`dpmain/README.md`** - dpmain æœåŠ¡è¯´æ˜ï¼ˆDDD æ¶æ„ï¼‰
4. **`dpsync/README.md`** - dpsync æœåŠ¡è¯´æ˜ï¼ˆWorker æ¶æ„ï¼‰
5. **`stories/`** - å½“å‰ä»»åŠ¡åˆ—è¡¨

## ğŸ”¨ å¸¸ç”¨å‘½ä»¤

### æ„å»ºä¸è¿è¡Œ
```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•
cd /Users/cooperswang/Documents/wsqyouth/oip/backend

# æ„å»ºæ‰€æœ‰æœåŠ¡
make build

# è¿è¡Œ dpmainï¼ˆAPI æœåŠ¡ï¼‰
make run-dpmain

# è¿è¡Œ dpsyncï¼ˆWorker æœåŠ¡ï¼‰
make run-dpsync

# è¿è¡Œé›†æˆæµ‹è¯•
make integration-test

# å¯åŠ¨åŸºç¡€è®¾æ–½ï¼ˆMySQL + Redis + Lmstfyï¼‰
docker-compose up -d
```

### Git æ“ä½œï¼ˆè‡ªåŠ¨åŒ–ï¼‰
```bash
# æ™ºèƒ½æäº¤ï¼ˆæ¨è - è‡ªåŠ¨æ£€æŸ¥ + æ ¼å¼åŒ– + æµ‹è¯•ï¼‰
../.claude/commands/commit.sh "feat: åŠŸèƒ½æè¿°"

# å¸¦ rebase çš„æäº¤
../.claude/commands/commit.sh "feat: åŠŸèƒ½æè¿°" --rebase

# ä¿®æ”¹ä¸Šæ¬¡æäº¤
../.claude/commands/commit.sh "fix: ä¿®å¤æè¿°" --amend

# å®Œæ•´è‡ªåŠ¨åŒ–ï¼ˆrebase + æäº¤ + æ¨é€ï¼‰
../.claude/commands/commit.sh "feat: åŠŸèƒ½æè¿°" --rebase --push

# æ‰‹åŠ¨ Git æ“ä½œï¼ˆä¸æ¨èï¼Œå»ºè®®ä½¿ç”¨ä¸Šé¢çš„è‡ªåŠ¨åŒ–å‘½ä»¤ï¼‰
# git add . && git commit -m "feat: åŠŸèƒ½æè¿°" && git push
```

### ä»£ç è´¨é‡æ£€æŸ¥
```bash
# æ ¼å¼åŒ–ä»£ç 
gofmt -w .

# é™æ€æ£€æŸ¥
go vet ./...

# è¿è¡Œæµ‹è¯•
go test ./... -v

# æ¸…ç†ä¾èµ–
go mod tidy
```

## ğŸ§  å…³é”®è®¾è®¡åŸåˆ™

### 1. æ¶æ„åˆ†å±‚ï¼ˆDDDï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         dpmain (API æœåŠ¡)           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  domains/                    â”‚   â”‚
â”‚  â”‚    â”œâ”€ entity/    (èšåˆæ ¹)   â”‚   â”‚
â”‚  â”‚    â”œâ”€ apimodel/  (DTO)       â”‚   â”‚
â”‚  â”‚    â”œâ”€ modules/   (ä¸šåŠ¡ç¼–æ’) â”‚   â”‚
â”‚  â”‚    â”œâ”€ repo/      (ä»“å‚¨æ¥å£) â”‚   â”‚
â”‚  â”‚    â””â”€ services/  (é¢†åŸŸæœåŠ¡) â”‚   â”‚
â”‚  â”‚  infra/          (åŸºç¡€è®¾æ–½)  â”‚   â”‚
â”‚  â”‚  server/         (HTTP é€‚é…) â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    common (å…±äº«å†…æ ¸ - Shared Kernel)â”‚
â”‚  â”œâ”€ entity/    (GORM æ¨¡å‹)         â”‚
â”‚  â”œâ”€ model/     (è¯Šæ–­ç»“æœç»“æ„)      â”‚
â”‚  â””â”€ dao/       (æ•°æ®è®¿é—®å±‚)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ•°æ®æµè½¬
**HTTP è¯·æ±‚æµï¼ˆåŒæ­¥ï¼‰**
```
HTTP Request
  â†“
handlers/order/ (è§£æ DTO)
  â†“
modules/mdorder/ (ä¸šåŠ¡ç¼–æ’)
  â†“
services/svorder/ (é¢†åŸŸé€»è¾‘)
  â†“
repo/rporder/ (ä»“å‚¨æ¥å£)
  â†“
infra/persistence/mysql/ (ä»“å‚¨å®ç°)
  â†“
common/dao/ (DAO å±‚)
  â†“
MySQL
```

**å¼‚æ­¥è¯Šæ–­æµï¼ˆWorkerï¼‰**
```
Lmstfy Queue
  â†“
dpsync/worker/worker.go (æ¶ˆè´¹æ¶ˆæ¯)
  â†“
handlers/composite_handler.go (æ‰§è¡Œè¯Šæ–­)
  â”œâ”€ shipping_calculator.go (è´¹ç‡è®¡ç®—)
  â””â”€ anomaly_checker.go (å¼‚å¸¸æ£€æµ‹)
  â†“
common/dao/ (æ›´æ–°è®¢å•çŠ¶æ€)
  â†“
MySQL + Redis Pub/Sub
```

### 3. æ ¸å¿ƒæœºåˆ¶

#### Smart Waitï¼ˆæ™ºèƒ½ç­‰å¾…ï¼‰
- dpmain æ¥æ”¶è®¢å•å Hold è¿æ¥ 10s
- è®¢é˜… Redis channel: `diagnosis:result:{order_id}`
- æ¨é€ Lmstfy é˜Ÿåˆ—è§¦å‘å¼‚æ­¥è¯Šæ–­
- 10s å†…æ”¶åˆ°ç»“æœ â†’ è¿”å› 200 OK
- è¶…æ—¶ â†’ è¿”å› 3001 Processing

#### å•è¡¨è®¾è®¡
- è¯Šæ–­ç»“æœç›´æ¥å­˜å‚¨åœ¨ `orders.diagnose_result` (JSON)
- ä¸ä½¿ç”¨ç‹¬ç«‹çš„ Diagnoses è¡¨
- ç®€åŒ–æŸ¥è¯¢ï¼Œé¿å… JOIN

#### æ‰©å±•æ€§è®¾è®¡
```json
{
  "items": [
    {"type": "shipping", "status": "SUCCESS", "data_json": {...}},
    {"type": "anomaly", "status": "SUCCESS", "data_json": {...}}
  ]
}
```
- æ–°å¢è¯Šæ–­ç±»å‹æ—¶ï¼Œåªéœ€è¿½åŠ æ•°ç»„å…ƒç´ 
- ä¸ä¿®æ”¹è¡¨ç»“æ„

### 4. ä»£ç è§„èŒƒ

#### å‘½åçº¦å®š
| å‰ç¼€ | å«ä¹‰ | ç¤ºä¾‹ |
|------|------|------|
| `et` | Entityï¼ˆå®ä½“ï¼‰ | `etorder.Order` |
| `md` | Moduleï¼ˆæ¨¡å—ï¼‰ | `mdorder.OrderModule` |
| `rp` | Repositoryï¼ˆä»“å‚¨ï¼‰ | `rporder.OrderRepository` |
| `sv` | Serviceï¼ˆæœåŠ¡ï¼‰ | `svorder.OrderService` |

#### é”™è¯¯å¤„ç†
```go
// âœ… ä½¿ç”¨ errors.Wrap ä¿ç•™å †æ ˆ
return nil, errors.Wrap(err, "failed to create order")

// âŒ ä¸è¦ç›´æ¥è¿”å› err
return nil, err
```

#### é…ç½®å¤–ç½®
```go
// âœ… ä» config.yaml è¯»å–
port := cfg.Server.Port

// âŒ ç¦æ­¢ç¡¬ç¼–ç 
port := 7777
```

#### å¼‚æ­¥ä¼˜å…ˆ
```go
// âœ… è€—æ—¶æ“ä½œå¼‚æ­¥åŒ–
lmstfy.Push("order_diagnose", job)

// âŒ ä¸è¦åŒæ­¥ç­‰å¾…
result := diagnosisEngine.Run() // é˜»å¡ HTTP è¯·æ±‚
```

## âš ï¸ å¸¸è§é”™è¯¯ï¼ˆæŒç»­æ›´æ–°ï¼‰

### é”™è¯¯ 1: å¾ªç¯ä¾èµ–
âŒ **é”™è¯¯**ï¼š`internal/service` ä¾èµ– `internal/handler`
âœ… **æ­£ç¡®**ï¼šä½¿ç”¨ interface è§£è€¦ï¼Œä¾èµ–å€’ç½®

### é”™è¯¯ 2: ç¡¬ç¼–ç é…ç½®
âŒ **é”™è¯¯**ï¼šç›´æ¥å†™ `"localhost:7777"`
âœ… **æ­£ç¡®**ï¼šä» `config.yaml` è¯»å–

### é”™è¯¯ 3: å¿˜è®°äº‹åŠ¡å›æ»š
âŒ **é”™è¯¯**ï¼š
```go
tx := db.Begin()
if err := dao.Create(tx, order); err != nil {
    return err // å¿˜è®°å›æ»š
}
tx.Commit()
```
âœ… **æ­£ç¡®**ï¼š
```go
tx := db.Begin()
defer func() {
    if err != nil {
        tx.Rollback()
    }
}()
```

### é”™è¯¯ 4: åœ¨ handler å±‚ç›´æ¥æ“ä½œæ•°æ®åº“
âŒ **é”™è¯¯**ï¼š
```go
func CreateOrder(c *gin.Context) {
    db.Create(&order) // handler ç›´æ¥æ“ä½œ DB
}
```
âœ… **æ­£ç¡®**ï¼š
```go
func CreateOrder(c *gin.Context) {
    orderModule.CreateOrder(ctx, payload) // è°ƒç”¨æ¨¡å—
}
```

### é”™è¯¯ 5: æœªå¤„ç† Redis è®¢é˜…æ³„æ¼
âŒ **é”™è¯¯**ï¼š
```go
sub := redis.Subscribe(channel)
// å¿˜è®°å…³é—­
```
âœ… **æ­£ç¡®**ï¼š
```go
sub := redis.Subscribe(channel)
defer sub.Close()
```

> **æ³¨æ„**: æ¯æ¬¡é‡åˆ°æ–°çš„é”™è¯¯ï¼Œè¯·è¿½åŠ åˆ°è¿™é‡Œï¼Œå¹¶æ›´æ–°åˆ° `/.claude/knowledge/common-mistakes.md`

## ğŸ“‚ ä»£ç ç»„ç»‡

### dpmain ç›®å½•ç»“æ„
```
dpmain/
â”œâ”€â”€ cmd/apiserver/          # ç¨‹åºå…¥å£ï¼ˆå•è¿›ç¨‹ HTTP + Consumerï¼‰
â”œâ”€â”€ internal/app/
â”‚   â”œâ”€â”€ domains/            # é¢†åŸŸå±‚
â”‚   â”‚   â”œâ”€â”€ entity/         # èšåˆæ ¹å’Œå€¼å¯¹è±¡
â”‚   â”‚   â”œâ”€â”€ apimodel/       # API æ¨¡å‹ï¼ˆDTOï¼‰
â”‚   â”‚   â”œâ”€â”€ modules/        # ä¸šåŠ¡ç¼–æ’
â”‚   â”‚   â”œâ”€â”€ repo/           # ä»“å‚¨æ¥å£
â”‚   â”‚   â””â”€â”€ services/       # é¢†åŸŸæœåŠ¡
â”‚   â”œâ”€â”€ infra/              # åŸºç¡€è®¾æ–½å±‚
â”‚   â”‚   â”œâ”€â”€ persistence/    # æŒä¹…åŒ–å®ç°
â”‚   â”‚   â””â”€â”€ mq/             # æ¶ˆæ¯é˜Ÿåˆ—
â”‚   â”œâ”€â”€ server/             # HTTP é€‚é…å±‚
â”‚   â”‚   â”œâ”€â”€ handlers/       # HTTP å¤„ç†å™¨
â”‚   â”‚   â”œâ”€â”€ routers/        # è·¯ç”±
â”‚   â”‚   â””â”€â”€ middlewares/    # ä¸­é—´ä»¶
â”‚   â””â”€â”€ pkg/                # å·¥å…·åŒ…
â”‚       â”œâ”€â”€ errorx/         # é”™è¯¯å¤„ç†
â”‚       â”œâ”€â”€ ginx/           # Gin æ‰©å±•
â”‚       â””â”€â”€ logger/         # æ—¥å¿—
â””â”€â”€ docs/                   # å¼€å‘æ–‡æ¡£
```

### common ç›®å½•ç»“æ„
```
common/
â”œâ”€â”€ entity/          # GORM æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ order.go     # Order å®ä½“
â”‚   â””â”€â”€ account.go   # Account å®ä½“
â”œâ”€â”€ model/           # è¯Šæ–­ç»“æœç»“æ„
â”‚   â”œâ”€â”€ diagnosis_result.go
â”‚   â”œâ”€â”€ shipping_result.go
â”‚   â”œâ”€â”€ anomaly_result.go
â”‚   â””â”€â”€ response.go
â””â”€â”€ dao/             # æ•°æ®è®¿é—®å±‚
    â”œâ”€â”€ order_dao.go
    â””â”€â”€ account_dao.go
```

### dpsync ç›®å½•ç»“æ„
```
dpsync/
â”œâ”€â”€ cmd/worker/              # Worker å…¥å£
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ worker/              # Worker æ ¸å¿ƒ
â”‚   â””â”€â”€ handlers/            # è¯Šæ–­å¤„ç†å™¨
â”‚       â”œâ”€â”€ composite_handler.go
â”‚       â”œâ”€â”€ shipping_calculator.go
â”‚       â””â”€â”€ anomaly_checker.go
â””â”€â”€ pkg/
    â”œâ”€â”€ config/
    â””â”€â”€ lmstfy/
```

## ğŸ¯ å½“å‰ Sprint

### è¿›è¡Œä¸­
- [ ] Story-001: åŸºç¡€è®¾æ–½æ­å»ºï¼ˆDocker Composeï¼‰
- [ ] Story-002: Account API å®ç°

### å·²å®Œæˆ
- [x] æ¶æ„è®¾è®¡å®Œæˆ
- [x] ç›®å½•ç»“æ„åˆ›å»º
- [x] Wire ä¾èµ–æ³¨å…¥é…ç½®

### å¾…å¼€å§‹
- [ ] Story-003: Order æ¥å…¥ API
- [ ] Story-004: Smart Wait æœºåˆ¶
- [ ] Story-005: dpsync Worker æ¡†æ¶

> è¯¦ç»†ä»»åŠ¡æ‹†åˆ†è§ `stories/` ç›®å½•

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: ç¼–è¯‘å¤±è´¥
```bash
# æ£€æŸ¥ Go ç‰ˆæœ¬
go version  # éœ€è¦ 1.21+

# æ¸…ç†å¹¶é‡æ–°ä¸‹è½½ä¾èµ–
go clean -modcache
go mod tidy
go mod download
```

### é—®é¢˜ 2: Wire ç”Ÿæˆå¤±è´¥
```bash
# é‡æ–°ç”Ÿæˆ Wire ä»£ç 
cd dpmain/cmd/apiserver
wire

cd dpsync/cmd/worker
wire
```

### é—®é¢˜ 3: æ•°æ®åº“è¿æ¥å¤±è´¥
```bash
# æ£€æŸ¥ MySQL æ˜¯å¦å¯åŠ¨
docker ps | grep mysql

# æ£€æŸ¥é…ç½®æ–‡ä»¶
cat dpmain/config/config.yaml
```

### é—®é¢˜ 4: Redis è¿æ¥å¤±è´¥
```bash
# æ£€æŸ¥ Redis æ˜¯å¦å¯åŠ¨
docker ps | grep redis

# æµ‹è¯•è¿æ¥
redis-cli ping
```

## ğŸ“š å­¦ä¹ èµ„æº

### DDD ç›¸å…³
- [é¢†åŸŸé©±åŠ¨è®¾è®¡](https://domain-driven-design.org/)
- [å…­è¾¹å½¢æ¶æ„](https://alistair.cockburn.us/hexagonal-architecture/)

### Go ç›¸å…³
- [Effective Go](https://go.dev/doc/effective_go)
- [Go Code Review Comments](https://github.com/golang/go/wiki/CodeReviewComments)

### Wire ä¾èµ–æ³¨å…¥
- [Wire User Guide](https://github.com/google/wire/blob/main/docs/guide.md)

## ğŸš€ å¼€å‘æµç¨‹

### 1. æ–°åŠŸèƒ½å¼€å‘
```bash
# 1. åˆ›å»º Story æ–‡ä»¶
cp stories/_template.md stories/story-XXX-åŠŸèƒ½å.md

# 2. åœ¨ Story ä¸­è¯¦ç»†è§„åˆ’

# 3. Plan æ¨¡å¼å¯¹é½ï¼ˆä¸ Claude åå•†ï¼‰

# 4. å¼€å§‹å®ç°

# 5. ç¼–å†™æµ‹è¯•

# 6. æäº¤ä»£ç 
git add .
git commit -m "feat: åŠŸèƒ½æè¿°"
```

### 2. Bug ä¿®å¤
```bash
# 1. å®šä½é—®é¢˜ï¼ˆæŸ¥çœ‹æ—¥å¿— + è°ƒè¯•ï¼‰

# 2. ä¿®å¤ä»£ç 

# 3. ç¼–å†™æµ‹è¯•é˜²æ­¢å›å½’

# 4. æäº¤
git commit -m "fix: é—®é¢˜æè¿°"
```

### 3. é‡æ„
```bash
# 1. ç¡®ä¿æœ‰å……è¶³çš„æµ‹è¯•è¦†ç›–

# 2. å°æ­¥é‡æ„

# 3. æ¯æ¬¡é‡æ„åè¿è¡Œæµ‹è¯•
make test

# 4. æäº¤
git commit -m "refactor: é‡æ„è¯´æ˜"
```

## ğŸ’¡ æç¤º

### ç»™ Claude çš„æç¤º
- âœ… æ€»æ˜¯å…ˆè¯»å– `.claude.md` ç†è§£ä¸Šä¸‹æ–‡
- âœ… ç¼–å†™ä»£ç å‰å…ˆè¿è¡Œ Plan æ¨¡å¼å¯¹é½
- âœ… æ¯æ¬¡ä¿®æ”¹åè¿è¡Œ `make test`
- âœ… é‡åˆ°é”™è¯¯æ—¶è¿½åŠ åˆ°"å¸¸è§é”™è¯¯"éƒ¨åˆ†
- âœ… å®ŒæˆåŠŸèƒ½åæ›´æ–° Story çŠ¶æ€

### ç»™å¼€å‘è€…çš„æç¤º
- âœ… æ¯æ¬¡æ–°ä¼šè¯å‰è®© Claude è¯»å–æ­¤æ–‡ä»¶
- âœ… ä¿æŒ PRD.md å’Œ .claude.md åŒæ­¥æ›´æ–°
- âœ… åŠæ—¶æ›´æ–° stories/ ä¸‹çš„ä»»åŠ¡çŠ¶æ€
- âœ… ç§¯ç´¯å¸¸è§é”™è¯¯åˆ°çŸ¥è¯†åº“
